<!-- templates/game_clear.html -->
{% extends "base.html" %}

{% block title %}Wiki Game - ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼{% endblock %}

{% block content %}
<div class="container game-over-page">
    <h1>GAME OVER!!!</h1>
    <div class="game-clear">
        <p>è«¦ã‚ãªã„ã‚‚ã®ã ã‘ãŒå‹ã¤</p>
        <div class="button-container">
            <button onclick="location.href='{{ url_for('opening') }}'">ã‚‚ã†ä¸€åº¦</button>
            <button class="share-btn" onclick="openSharePopup();">çµæœã‚’ã‚·ã‚§ã‚¢</button>
        </div>
        
        <!-- ã‚·ã‚§ã‚¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
        <div id="sharePopup" class="share-popup">
            <div class="share-popup-content">
                <div class="share-popup-header">
                    <h3>çµæœã‚’ã‚·ã‚§ã‚¢</h3>
                    <button type="button" class="close-btn" onclick="closeSharePopup()">Ã—</button>
                </div>
                <div class="share-image-container">
                    <canvas id="resultCanvas" width="400" height="300"></canvas>
                </div>
                <div class="share-buttons">
                    <button class="share-btn-twitter" onclick="shareToTwitter()">
                        <span class="icon">ğŸ¦</span>
                        Twitter
                    </button>
                    <button class="share-btn-instagram" onclick="shareToInstagram()">
                        <span class="icon">ğŸ“·</span>
                        Instagram
                    </button>
                    <button class="share-btn-copy" onclick="copyLink()">
                        <span class="icon">ğŸ“‹</span>
                        ãƒªãƒ³ã‚¯ã‚³ãƒ”ãƒ¼
                    </button>
                    <button class="share-btn-download" onclick="downloadImage()">
                        <span class="icon">â¬‡ï¸</span>
                        ç”»åƒä¿å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
    // ã‚·ã‚§ã‚¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—é–¢é€£ã®é–¢æ•°
    function openSharePopup() {
        const popup = document.getElementById('sharePopup');
        popup.classList.add('show');
        generateResultImage();
    }

    function closeSharePopup() {
        const popup = document.getElementById('sharePopup');
        popup.classList.remove('show');
    }

    // ãƒªã‚¶ãƒ«ãƒˆç”»åƒã‚’ç”Ÿæˆï¼ˆã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”¨ï¼‰
    function generateResultImage() {
        const canvas = document.getElementById('resultCanvas');
        const ctx = canvas.getContext('2d');
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’è¨­å®š
        canvas.width = 400;
        canvas.height = 300;
        
        // èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆè½ã¡ç€ã„ãŸè‰²ï¼‰
        const gradient = ctx.createLinearGradient(0, 0, 400, 300);
        gradient.addColorStop(0, '#f8f9fa');
        gradient.addColorStop(1, '#e9ecef');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 400, 300);
        
        // ã‚¿ã‚¤ãƒˆãƒ«
        ctx.fillStyle = '#212529';
        ctx.font = 'bold 32px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Wiki SixHop', 200, 60);
        
        // ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«
        ctx.font = 'bold 24px Arial';
        ctx.fillText('GAME OVER', 200, 100);
        
        // ã‚¹ã‚³ã‚¢æƒ…å ±ã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        const clicks = urlParams.get('clicks') || 0;
        const time = urlParams.get('time') || 0;
        const target = urlParams.get('target') || 'ãƒã‚³';
        
        const timeSec = (time / 1000).toFixed(1);
        
        // ã‚¹ã‚³ã‚¢è¡¨ç¤º
        ctx.font = '20px Arial';
        ctx.fillText(`ã‚¹ã‚³ã‚¢: ${clicks}ã‚¯ãƒªãƒƒã‚¯ / ${timeSec}ç§’`, 200, 140);
        
        if (target && target !== 'ãƒã‚³') {
            ctx.fillText(`ç›®æ¨™: ${target}`, 200, 170);
        }
        
        // åŠ±ã¾ã—ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        ctx.font = '16px Arial';
        ctx.fillText('è«¦ã‚ãªã„ã‚‚ã®ã ã‘ãŒå‹ã¤', 200, 220);
        
        // ãƒ•ãƒƒã‚¿ãƒ¼
        ctx.font = '14px Arial';
        ctx.fillText('Wiki SixHopã§å†æŒ‘æˆ¦ã—ã‚ˆã†ï¼', 200, 280);
    }

    // ã‚·ã‚§ã‚¢æ©Ÿèƒ½
    function shareToTwitter() {
        const urlParams = new URLSearchParams(window.location.search);
        const clicks = urlParams.get('clicks') || 0;
        const time = urlParams.get('time') || 0;
        const target = urlParams.get('target') || 'ãƒã‚³';
        
        const timeSec = (time / 1000).toFixed(1);
        let text = `Wiki SixHopã§ ${clicks}ã‚¯ãƒªãƒƒã‚¯ / ${timeSec}ç§’ã§ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼`;
        if (target && target !== 'ãƒã‚³') {
            text += ` (ç›®æ¨™: ${target})`;
        }
        text += ' #WikiLink';
        
        const url = location.href;
        const intent = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
        window.open(intent, '_blank');
    }

    function shareToInstagram() {
        // Instagramã¯ç›´æ¥æŠ•ç¨¿ã§ããªã„ãŸã‚ã€ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦æ¡ˆå†…
        const canvas = document.getElementById('resultCanvas');
        const dataURL = canvas.toDataURL('image/png');
        
        // ä¸€æ™‚çš„ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
        const link = document.createElement('a');
        link.download = 'wiki-link-game-over.png';
        link.href = dataURL;
        link.click();
        
        alert('ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼\nInstagramã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚·ã‚§ã‚¢ã—ã¦ãã ã•ã„ã€‚');
    }

    function copyLink() {
        const url = location.href;
        navigator.clipboard.writeText(url).then(() => {
            alert('ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        }).catch(() => {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            const textArea = document.createElement('textarea');
            textArea.value = url;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        });
    }

    function downloadImage() {
        const canvas = document.getElementById('resultCanvas');
        const dataURL = canvas.toDataURL('image/png');
        
        const link = document.createElement('a');
        link.download = 'wiki-link-game-over.png';
        link.href = dataURL;
        link.click();
    }

    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.addEventListener('click', function(event) {
        const popup = document.getElementById('sharePopup');
        if (event.target === popup) {
            closeSharePopup();
        }
    });

    // ESCã‚­ãƒ¼ã§é–‰ã˜ã‚‹
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeSharePopup();
        }
    });
</script>
</div>
{% endblock %}
