<!-- templates/game_clear.html -->
{% extends "base.html" %}

{% block title %}Wiki SixHop - ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢{% endblock %}

{% block content %}
<div class="container">
    <div class="game-clear">
        <h1>GAME CLEAR!!</h1>
        <p>ãŠã‚ã§ã¨ã†â€¼ï¸</p>
        
        <!-- ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="score-display">
            <p id="current-score">ä»Šå›ã®ã‚¹ã‚³ã‚¢: <span id="score-details"></span></p>
        </div>
        
        <!-- ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <div class="ranking-section">
            <h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
            <div id="result" class="ranking-list"></div>
        </div>
        
        <!-- ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
        <div class="button-container">
            <button onclick="location.href='{{ url_for('opening') }}'">ãƒ›ãƒ¼ãƒ </button>
            <button class="share-btn" onclick="openSharePopup();">çµæœã‚’ã‚·ã‚§ã‚¢</button>
        </div>
        
        <!-- ã‚·ã‚§ã‚¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
        <div id="sharePopup" class="share-popup">
            <div class="share-popup-content">
                <div class="share-popup-header">
                    <h3>çµæœã‚’ã‚·ã‚§ã‚¢</h3>
                    <button type="button" class="close-btn" onclick="closeSharePopup()">Ã—</button>
                </div>
                <div class="share-image-container">
                    <canvas id="resultCanvas" width="400" height="300"></canvas>
                </div>
                <div class="share-buttons">
                    <button class="share-btn-twitter" onclick="shareToTwitter()">
                        <span class="icon">ğŸ¦</span>
                        Twitter(X)
                    </button>
                    <button class="share-btn-instagram" onclick="shareToInstagram()">
                        <span class="icon">ğŸ“·</span>
                        Instagram
                    </button>
                    <button class="share-btn-copy" onclick="copyLink()">
                        <span class="icon">ğŸ“‹</span>
                        ãƒªãƒ³ã‚¯ã‚³ãƒ”ãƒ¼
                    </button>
                    <button class="share-btn-download" onclick="downloadImage()">
                        <span class="icon">â¬‡ï¸</span>
                        ç”»åƒä¿å­˜
                    </button>
                </div>
            </div>
        </div>
<script>
    // ã‚·ã‚§ã‚¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—é–¢é€£ã®é–¢æ•°
    function openSharePopup() {
        const popup = document.getElementById('sharePopup');
        popup.classList.add('show');
        generateResultImage();
    }

    function closeSharePopup() {
        const popup = document.getElementById('sharePopup');
        popup.classList.remove('show');
    }

    // ãƒªã‚¶ãƒ«ãƒˆç”»åƒã‚’ç”Ÿæˆ
    function generateResultImage() {
        const canvas = document.getElementById('resultCanvas');
        const ctx = canvas.getContext('2d');
        
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’è¨­å®š
        canvas.width = 400;
        canvas.height = 300;
        
        // èƒŒæ™¯ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        const gradient = ctx.createLinearGradient(0, 0, 400, 300);
        gradient.addColorStop(0, '#f8f9fa');
        gradient.addColorStop(1, '#e9ecef');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, 400, 300);
        
        // ã‚¿ã‚¤ãƒˆãƒ«
        ctx.fillStyle = '#212529';
        ctx.font = 'bold 32px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('Wiki SixHop', 200, 60);
        
        // ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«
        ctx.font = 'bold 24px Arial';
        ctx.fillText('GAME CLEAR!', 200, 100);
        
        // ã‚¹ã‚³ã‚¢æƒ…å ±ã‚’å–å¾—
        const urlParams = new URLSearchParams(window.location.search);
        const clicks = urlParams.get('clicks') || 0;
        const time = urlParams.get('time') || 0;
        const target = urlParams.get('target') || 'ãƒã‚³';
        
        const timeSec = (time / 1000).toFixed(1);
        
        // ã‚¹ã‚³ã‚¢è¡¨ç¤º
        ctx.font = '20px Arial';
        ctx.fillText(`ã‚¹ã‚³ã‚¢: ${clicks}ã‚¯ãƒªãƒƒã‚¯ / ${timeSec}ç§’`, 200, 140);
        
        if (target && target !== 'ãƒã‚³') {
            ctx.fillText(`ç›®æ¨™: ${target}`, 200, 170);
        }
        
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°æƒ…å ±
        const ranking = getRanking().slice(0, 3);
        ctx.font = '16px Arial';
        ctx.fillText('ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°', 200, 200);
        
        ranking.forEach((score, index) => {
            const rank = index + 1;
            const timeText = (score.time / 1000).toFixed(1);
            ctx.fillText(`${rank}ä½: ${score.clicks}ã‚¯ãƒªãƒƒã‚¯ / ${timeText}ç§’`, 200, 220 + (index * 20));
        });
        
        // ãƒ•ãƒƒã‚¿ãƒ¼
        ctx.font = '14px Arial';
        ctx.fillText('Wiki SixHopã§éŠã¼ã†ï¼', 200, 280);
    }

    // ã‚·ã‚§ã‚¢æ©Ÿèƒ½
    function shareToTwitter() {
        const urlParams = new URLSearchParams(window.location.search);
        const clicks = urlParams.get('clicks') || 0;
        const time = urlParams.get('time') || 0;
        const target = urlParams.get('target') || 'ãƒã‚³';
        
        const timeSec = (time / 1000).toFixed(1);
        let text = `Wiki SixHopã§ ${clicks}ã‚¯ãƒªãƒƒã‚¯ / ${timeSec}ç§’ï¼`;
        if (target && target !== 'ãƒã‚³') {
            text += ` (ç›®æ¨™: ${target})`;
        }
        text += ' #WikiSixHop';
        
        const url = location.href;
        const intent = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`;
        window.open(intent, '_blank');
    }

    function shareToInstagram() {
        // Instagramã¯ç›´æ¥æŠ•ç¨¿ã§ããªã„ãŸã‚ã€ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦æ¡ˆå†…
        const canvas = document.getElementById('resultCanvas');
        const dataURL = canvas.toDataURL('image/png');
        
        // ä¸€æ™‚çš„ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
        const link = document.createElement('a');
        link.download = 'wiki-link-result.png';
        link.href = dataURL;
        link.click();
        
        alert('ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼\nInstagramã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚·ã‚§ã‚¢ã—ã¦ãã ã•ã„ã€‚');
    }

    function copyLink() {
        const url = location.href;
        navigator.clipboard.writeText(url).then(() => {
            alert('ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        }).catch(() => {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            const textArea = document.createElement('textarea');
            textArea.value = url;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            alert('ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
        });
    }

    function downloadImage() {
        const canvas = document.getElementById('resultCanvas');
        const dataURL = canvas.toDataURL('image/png');
        
        const link = document.createElement('a');
        link.download = 'wiki-link-result.png';
        link.href = dataURL;
        link.click();
    }

    // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.addEventListener('click', function(event) {
        const popup = document.getElementById('sharePopup');
        if (event.target === popup) {
            closeSharePopup();
        }
    });

    // ESCã‚­ãƒ¼ã§é–‰ã˜ã‚‹
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closeSharePopup();
        }
    });
</script>
<script>
    // ç”»é¢å¹…ã«å¿œã˜ã¦ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®é–‹å§‹ä½ç½®ã‚’èª¿æ•´
    var originY = window.innerWidth < 768 ? 0.4 : 0.6;

    // confettiãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«å®Ÿè¡Œ
    function startConfetti() {
        if (typeof confetti !== 'undefined') {
            // ãƒ¡ã‚¤ãƒ³ã®ã‚¯ãƒ©ãƒƒã‚«ãƒ¼
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: originY }
            });

            // è¿½åŠ ã®ã‚¯ãƒ©ãƒƒã‚«ãƒ¼ï¼ˆå°‘ã—é…å»¶ï¼‰
            setTimeout(() => {
                confetti({
                    particleCount: 50,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0, y: originY }
                });
            }, 250);

            setTimeout(() => {
                confetti({
                    particleCount: 50,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1, y: originY }
                });
            }, 400);

            // æœ€å¾Œã®å¤§çˆ†ç™º
            setTimeout(() => {
                confetti({
                    particleCount: 200,
                    spread: 100,
                    origin: { y: originY }
                });
            }, 800);
        } else {
            console.error('confetti library not loaded');
        }
    }

    // DOMContentLoadedã‚¤ãƒ™ãƒ³ãƒˆã§å®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', function() {
        startConfetti();
    });

    function saveScore({ clicks, timeMs, challengeId = "default" }) {
        try {
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
            if (!clicks || clicks <= 0 || !timeMs || timeMs <= 0) {
                console.warn('Invalid score data:', { clicks, timeMs, challengeId });
                return [];
            }
            
            const raw = localStorage.getItem("scores");
            const scores = raw ? JSON.parse(raw) : [];
            
            // æ–°ã—ã„ã‚¹ã‚³ã‚¢ã‚’è¿½åŠ 
            scores.push({
                clicks,
                time: timeMs,
                challengeId,
                date: new Date().toISOString(),
            });
        
            // ã‚¯ãƒªãƒƒã‚¯æ•°â†’æ™‚é–“ã®é †ã§æ˜‡é †ã‚½ãƒ¼ãƒˆ
            scores.sort((a, b) => (a.clicks - b.clicks) || (a.time - b.time));
        
            // å…ˆé ­10ä»¶ã ã‘æ®‹ã™
            const top10 = scores.slice(0, 10);
            localStorage.setItem("scores", JSON.stringify(top10));
            return top10;
        } catch (error) {
            console.error('Error saving score:', error);
            return [];
        }
    }

    function getRanking() {
        try {
            const raw = localStorage.getItem("scores");
            const scores = raw ? JSON.parse(raw) : [];
            // å¿µã®ãŸã‚æ¯å›ã‚½ãƒ¼ãƒˆï¼ˆä¿å­˜æ™‚ã¨åŒã˜åŸºæº–ï¼‰
            return scores.sort((a, b) => (a.clicks - b.clicks) || (a.time - b.time));
        } catch (error) {
            console.error('Error getting ranking:', error);
            return [];
        }
    }

    function renderRanking(containerId = "result", limit = 5) {
        const ranking = getRanking().slice(0, limit);
        const el = document.getElementById(containerId);
        if (!el) return;
    
        if (ranking.length === 0) {
        el.innerHTML = "<p>ã¾ã ã‚¹ã‚³ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
        return;
        }
    
        el.innerHTML = ranking.map((s, i) => {
        const sec = (s.time / 1000).toFixed(1);
        const date = new Date(s.date).toLocaleString();
        return `<p>${i + 1}ä½ï¼š${s.clicks}ã‚¯ãƒªãƒƒã‚¯ / ${sec}ç§’ <span style="opacity:.7">(${date})</span></p>`;
        }).join("");
    }

    function shareBest() {
        const best = getRanking()[0];
        if (!best) return alert("ã¾ã ã‚¹ã‚³ã‚¢ãŒãªã„ã‚ˆï¼");
        const text = `Wiki SixHopã§ ${best.clicks}ã‚¯ãƒªãƒƒã‚¯ / ${(best.time/1000).toFixed(1)}ç§’ï¼`;
        const url = location.href;
        // X(Twitter) Intent
        const intent = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}&hashtags=WikiLink`;
        window.open(intent, "_blank");
    }


    // ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã¨ã‚¹ã‚³ã‚¢ä¿å­˜
    function initializeGameClear() {
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆå„ªå…ˆï¼‰
        const urlParams = new URLSearchParams(window.location.search);
        let clicks = parseInt(urlParams.get('clicks')) || 0;
        let timeMs = parseInt(urlParams.get('time')) || 0;
        let target = urlParams.get('target') || 'ãƒã‚³';
        
        // ãƒ‡ãƒãƒƒã‚°: URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å€¤ã‚’ç¢ºèª
        console.log('URL parameters:', {
            clicks_param: urlParams.get('clicks'),
            timeMs_param: urlParams.get('time'),
            target_param: urlParams.get('target')
        });
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã‹ã‚‰ã‚‚å–å¾—ã‚’è©¦è¡Œ
        if (clicks === 0) clicks = parseInt("{{ clicks|default(0) }}") || 0;
        if (timeMs === 0) timeMs = parseInt("{{ time_ms|default(0) }}") || 0;
        if (target === 'ãƒã‚³') target = "{{ target|default('ãƒã‚³') }}";
        
        // ãƒ‡ãƒãƒƒã‚°: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ã®ç”Ÿã®å€¤ã‚’ç¢ºèª
        console.log('Template fallback values:', {
            clicks_template: "{{ clicks|default(0) }}",
            timeMs_template: "{{ time_ms|default(0) }}",
            target_template: "{{ target|default('ãƒã‚³') }}"
        });
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
        console.log('Game Clear Data:', { clicks, timeMs, target });
        console.log('URL:', window.location.href);
        console.log('Template variables:', { 
            clicks_template: "{{ clicks|default(0) }}", 
            timeMs_template: "{{ time_ms|default(0) }}", 
            target_template: "{{ target|default('ãƒã‚³') }}" 
        });
        
        // ã‚¹ã‚³ã‚¢è¡¨ç¤ºã‚’æ›´æ–°
        const scoreDetails = document.getElementById('score-details');
        console.log('Score display check:', { scoreDetails: !!scoreDetails, clicks, timeMs, target });
        
        if (scoreDetails) {
            // ã‚ˆã‚ŠæŸ”è»Ÿãªæ¡ä»¶ã§ã‚¹ã‚³ã‚¢è¡¨ç¤º
            if (clicks >= 0 && timeMs >= 0 && target && target !== 'ãƒã‚³') {
                const timeSec = (timeMs / 1000).toFixed(1);
                scoreDetails.textContent = `${clicks}ã‚¯ãƒªãƒƒã‚¯ / ${timeSec}ç§’ (ç›®æ¨™: ${target})`;
                
                // ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜
                const challengeId = `target_${target}_${new Date().toISOString().split('T')[0]}`;
                const savedScores = saveScore({ clicks, timeMs, challengeId });
                console.log('Saved scores:', savedScores);
            } else if (clicks >= 0 && timeMs >= 0) {
                // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚‚ã‚¯ãƒªãƒƒã‚¯æ•°ã¨æ™‚é–“ãŒã‚ã‚Œã°è¡¨ç¤º
                const timeSec = (timeMs / 1000).toFixed(1);
                scoreDetails.textContent = `${clicks}ã‚¯ãƒªãƒƒã‚¯ / ${timeSec}ç§’`;
                
                // ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜
                const challengeId = `target_${target}_${new Date().toISOString().split('T')[0]}`;
                const savedScores = saveScore({ clicks, timeMs, challengeId });
                console.log('Saved scores:', savedScores);
            } else {
                scoreDetails.textContent = `ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™ (clicks: ${clicks}, time: ${timeMs}, target: ${target})`;
                console.log('Invalid score data:', { clicks, timeMs, target });
            }
        } else {
            console.error('Score details element not found');
        }
        
        // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’è¡¨ç¤º
        renderRanking("result", 5);
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    document.addEventListener('DOMContentLoaded', initializeGameClear);
</script>
{% endblock %}
